@import ix.ginas.controllers.GinasApp
@import be.objectify.deadbolt.java.views.html._
@import views.html._
@import be.objectify.deadbolt.java.views.html._
@import ix.ncats.controllers.security.IxDynamicResourceHandler

@(sub: ix.ginas.models.v1.Substance)(breadcrumb: Html)(details: Html)(content: Html)


@ix.ginas.views.html.ginas(sub.getName, "ix.ginas.models.v1.Substance") {
    @ix.ginas.views.html.menu()
} {

    <div class = "row">

        <div class = "col-md-3 hidden-xs hidden-sm sidebar">
            <h3 class="display-name"><em>@sub.getName()</em></h3>
           <nav id="breadcrumb">
                <ul class="nav nav-pills nav-stacked" id="breadcrumb-list">
                    <li role="presentation" class ="text-capitalize active"><a href="#details" prevent-default="" ng-click="scrollTo('details')">
                        {{_.startCase('@sub.substanceClass')}} Details</a></li>

                    <li role="presentation"><a href="#audit" prevent-default="" ng-click="scrollTo('audit')">
                        Audit Information </a></li>

                    @if(sub.getAlternativeDefinitionRelationships().size() > 0) {
                        <li role="presentation" ><a href="#altrelationships" prevent-default="" ng-click="scrollTo('altrelationships')">
                            Alt Definitions <span class="badge pull-right">@sub.getAlternativeDefinitionRelationships().size()</span></a></li>
                    }
                     @if(sub.getPrimaryDefinitionReference() != null) {
                        <li role="presentation" ><a href="#pridefinition" prevent-default="" ng-click="scrollTo('pridefinition')">
                            Primary Definition </a></li>
                    }
                    @breadcrumb
                    @defining(sub.getModificationCount()) { gcount =>
                        @if(gcount > 0) {
                            <li role="presentation"><a href="#modification" prevent-default="" ng-click="scrollTo('modification')">
                                Modifications
                                <span class= "badge pull-right">@gcount</span></a>
                            </li>
                        }
                    }
                    @if(sub.getAllNames().size() > 0) {
                        <li role="presentation" ><a href="#names" prevent-default="" ng-click="scrollTo('names')">
                            Names <span class="badge pull-right">@sub.names.size()</span></a></li>
                    }
                    @if(sub.codes.size() > 0) {
                        <li role="presentation"><a href="#codes" prevent-default="" ng-click="scrollTo('codes')">
                            Codes <span class="badge pull-right">@sub.codes.size()</span></a></li>
                    }
                    @if(sub.getActiveMoieties.size() > 0) {
                        <li role="presentation" ><a href="#activemoieties" prevent-default="" ng-click="scrollTo('activemoieties')" >
                            Active Moieties <span class="badge pull-right">@sub.getActiveMoieties.size()</span></a></li>
                    }
                    @if(sub.getMetabolites.size() > 0) {
                        <li role="presentation" ><a href="#metabolites" prevent-default="" ng-click="scrollTo('metabolites')" >
                            Metabolites <span class="badge pull-right">@sub.getMetabolites.size()</span></a></li>
                    }
                    @if(sub.getImpurities.size() > 0) {
                        <li role="presentation" ><a href="#impurities" prevent-default="" ng-click="scrollTo('impurities')">
                            Impurities <span class="badge pull-right">@sub.getImpurities.size()</span></a></li>
                    }
                    @if(sub.getFilteredRelationships.size() > 0) {
                        <li role="presentation" ><a href="#relationships" prevent-default="" ng-click="scrollTo('relationships')" id = "relation">
                            Relationships <span class="badge pull-right">@sub.getFilteredRelationships.size()</span></a></li>
                    }
                    @if(sub.properties.size() > 0) {
                        <li role="presentation"><a href="#properties" prevent-default="" ng-click="scrollTo('properties')">
                            Properties <span class="badge pull-right">@sub.properties.size()</span></a></li>
                    }
                    @if(sub.notes.size() > 0) {
                        <li role="presentation"><a href="#notes" prevent-default="" ng-click="scrollTo('notes')">
                            Notes <span class="badge pull-right">@sub.notes.size()</span></a></li>
                    }
                    <li role="presentation"><a href="#refs" prevent-default="" ng-click="scrollTo('refs')">
                        References <span class="badge pull-right">@sub.references.size()</span></a></li>
                    <li role="presentation"><a href="#history" prevent-default="" ng-click="scrollTo('history')">
                        History </a></li>
                </ul>
            </nav>
        </div>
        <div class = "col-md-9 col-md-offset-3 col-xs-12">
            <div class="row info" id="details">
                <button class="btn btn-primary label-offset det text-capitalize" ng-click = "detiscollapsed=!detiscollapsed">
                    <i ng-cloak ="" ng-show="detiscollapsed" class="fa fa-caret-right"></i>
                    <i ng-cloak ="" ng-hide="detiscollapsed" class="fa fa-caret-down"></i>
                    @sub.substanceClass Details</button>
                <div class ="col-md-12" uib-collapse="detiscollapsed">
                    <div class = "row">
                        <div class="col-md-4">
                            <code class="text-uppercase">Record Status: @sub.getDisplayStatus()</code> <br>
                            <code class ="text-uppercase"> version:
                                <select aria-label="version" ng-init ="versionNumber = '@sub.version'" ng-model = "versionNumber" ng-model-options="{ getterSetter: true }" ng-change = "redirectVersion()">
                                    <option ng-repeat="v in getRange(1, '@sub.version');">{{v}}</option></select>
                            </code><br/>
                        <div>View audit details:  <input type="checkbox" ng-model="audit"></div>
                        </div>
                        
                        <div class = "col-md-3 pull-right">
                            <h5>Substance ID:</h5>
                            @if(sub.isSubstanceVariant()) {
                                <h3 class= "appid subconcept"> @sub.getApprovalIDDisplay()</h3>
                            } else {
                                <h3 class= "appid">@sub.getApprovalIDDisplay()</h3>
                            }
                            <div class = "pull-left">
                                <ul class= "list-inline pull-right list-unstyled">
                                @dynamic(name = IxDynamicResourceHandler.CAN_UPDATE, handler = new ix.ncats.controllers.security.IxDeadboltHandler()) {
                                    <li>
                                        <a href="@ix.ginas.controllers.routes.GinasFactory.edit(GinasApp.getId(sub))" target="_self" uib-tooltip="Edit Substance" aria-label="Edit Substance">
                                            <span class="sr-only">Edit Substance</span>
                                            <span class="fa fa-pencil fa-2x success"></span></a>
                                    </li>
                                }
                                    <li> <download-button uuid="@sub.getUuid" format = format>Download</download-button></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                  
                    <div class = "row table-responsive">
                    @details
                    </div>
                </div>
            </div>
             			
              <div class="row info" id="audit">
		                <button ng-init="auditscollapse=true" class="btn btn-primary label-offset det" ng-click = "auditscollapse = !auditscollapse">
		                    <i ng-show="auditscollapse" class="fa fa-caret-right"></i>
		                    <i ng-hide="auditscollapse" class="fa fa-caret-down"></i>
		                   Audit Information</button>
		                <div class="col-md-12 table-responsive" uib-collapse = "auditscollapse">
		                	<div class="row small-spacer">
			                    <table class="table table-striped keyvalue">
			                    <tbody>
			                    	@if(sub.approved!=null){
			                        	<tr><td> Approved </td><td>@sub.approved</td></tr>
			                        	<tr><td> Approved By </td><td>@sub.approvedBy</td></tr>
			                        }
			                        <tr><td> Created </td><td>@sub.created</td></tr>
			                        <tr><td> Created By </td><td>@sub.createdBy</td></tr>
			                        <tr><td> lastEdited </td><td>@sub.lastEdited</td></tr>
			                        <tr><td> lastEdited By </td><td>@sub.lastEditedBy</td></tr>
			                        @if(sub.changeReason != null){
			                            <tr><td>Change Reason</td><td>@sub.changeReason</td></tr>
			                        }
			                	</tbody>
			                	</table>
		                	</div>
		                </div>
		           </div>

         @if(sub.getAlternativeDefinitionRelationships().size() > 0) {
                <div class="row info table-responsive" id="altrelationships">
                @properties.relationships(sub.getAlternativeDefinitionRelationships(), "Alternative Definitions", sub.uuid.toString, false)
                </div>
            }
            @if(sub.getPrimaryDefinitionReference() != null) {
                <div class="row info table-responsive" id="pridefinition">
                	@properties.primarydefinition(sub.getPrimaryDefinitionReference())
                </div>
            }

            @content

            @if(sub.hasModifications()) {

                <div class="row info" id="modification">
                    <button class="btn btn-primary label-offset det" ng-click = "modscollapse = !modscollapse">
                        <i ng-show="modscollapse" class="fa fa-caret-right"></i>
                        <i ng-hide="modscollapse" class="fa fa-caret-down"></i>
                        Modifications&nbsp;<span class="badge head">
                            @sub.getModificationCount()</span></button>
                        <div class="col-md-12 table-responsive" uib-collapse = "modscollapse">
                        @if(sub.getModifications().agentModifications.size > 0) {
                            @properties.agentmodifications(sub.getModifications().agentModifications)
                        }
                        @if(sub.getModifications().physicalModifications.size > 0) {
                            @properties.physicalmodifications(sub.getModifications().physicalModifications)
                        }
                        @if(sub.getModifications().structuralModifications.size > 0) {
                            @properties.structuralmodifications(sub.getModifications().structuralModifications)
                        }
                    </div>
                </div>
            }
            @if(sub.getAllNames().size() > 0) {
                <div class="row info" id="names">
                @properties.names(sub.getAllNames(), sub)
                </div>
            }
             @if(sub.codes.size() > 0) {
                <div class="row info " id="codes">
                @properties.codes(sub.codes, sub.uuid.toString)
                </div>
            }
            @if(sub.hasChildConceptReferences()) {
                <div class="row info " id="variants">
                @properties.variantconcepts(sub)
                </div>
            }

            @if(sub.getActiveMoieties().size() > 0) {
                <div class="row info " id="activemoieties">
                @properties.relationships(sub.getActiveMoieties(), "Active Moieties", sub.uuid.toString)
                </div>
            }

            @if(sub.getMetabolites().size() > 0) {
                <div class="row info " id="metabolites">
                @properties.relationships(sub.getMetabolites(), "Metabolites", sub.uuid.toString)
                </div>
            }

            @if(sub.getImpurities().size() > 0) {
                <div class="row info " id="impurities">
                @properties.relationships(sub.getImpurities(), "Impurities", sub.uuid.toString)
                </div>
            }

            @if(sub.getFilteredRelationships().size() > 0) {
                <div class="row info " id="relationships">
                @properties.relationships(sub.getFilteredRelationships(), "Relationships", sub.uuid.toString)
                </div>
            }

            @if(sub.properties != null && sub.properties.size() > 0) {
                <div class="row info " id="properties">
                @properties.properties(sub.properties, sub.uuid.toString)
                </div>
            }
            @if(sub.notes != null && sub.notes.size() > 0) {
                <div class="row info " id="notes">
                @properties.notes(sub.getDisplayNotes(), sub.uuid.toString)
                </div>
            }

            <div class="row info" id="refs">
                <button class="btn btn-primary label-offset det" ng-click = "referencescollapse = !referencescollapse">
                    <i ng-show="referencescollapse" class="fa fa-caret-right"></i>
                    <i ng-hide="referencescollapse" class="fa fa-caret-down"></i>
                    References&nbsp;<span class="badge"> @sub.references.size()</span></button>
                <div class="col-md-12 table-responsive" uib-collapse = "referencescollapse">
                    <referencesmanager reftable substance ="'@sub.uuid'"></referencesmanager>
                    </div>
            </div>
			<div class="row info" id="history">
		                <button ng-init="historyscollapse=true" class="btn btn-primary label-offset det" ng-click = "historyscollapse = !historyscollapse">
		                    <i ng-show="historyscollapse" class="fa fa-caret-right"></i>
		                    <i ng-hide="historyscollapse" class="fa fa-caret-down"></i>
		                   History</button>
		                <div class="col-md-12 table-responsive" uib-collapse = "historyscollapse">
		                	<div>
	                            <div class="row">
	                            		<div class="col-md-1">
	                            			<h4>Version</h4>
	                            		</div>
	                            		<div class="col-md-3">
	                            			<h4>Change Reason</h4>
	                            		</div>
	                            		<div class="col-md-2">
	                            			<h4>Editor</h4>
	                            		</div>
	                            		<div class="col-md-3">
	                            			<h4>Change Date</h4>
	                            		</div>
	                            		<div class="col-md-1">
	                            		</div>
                                        <div class="col-md-1">
                                        </div>
	                            </div>
	                            @for(edit<-sub.getEdits()){
	                            	<div class="row striped">
	                            		<div class="col-md-1">
	                            			@edit.version
	                            		</div>
	                            		<div class="col-md-3">
	                            			@edit.comments
	                            		</div>
	                            		<div class="col-md-2">
	                            			@edit.editor
	                            		</div>
	                            		<div class="col-md-3">
	                            			@edit.getCreatedDate()
	                            		</div>
	                            		<div class="col-md-1">
	                            			<div><a href="@ix.ginas.controllers.routes.GinasApp.substanceVersion(GinasApp.getId(sub), edit.version)" target="_self">View</a></div>
	                            		</div>
                                        <div class="col-md-1">
                                            <div><a href="@edit.getDiffLink()" target="_blank">Compare</a></div>
                                        </div>
	                            	</div>
	                            }
                            </div>
		                </div>
		           </div>
            
        </div>
</div>
}