@import ix.idg.models.Target
@import ix.idg.controllers.IDGApp
@import ix.idg.controllers.Commons._
@import ix.ncats.controllers.App.FacetDecorator

@(current: Int, rows: Int, total: Int, pages: Array[Int],
facets: Array[FacetDecorator], targets: List[Target], ctx: String )


@tabrow(t: Target) = {
    <tr id="row-@IDGApp.getId(t)">
        <td><input type="checkbox" class="cb-table-row" id="cb-@IDGApp.getId(t)" /></td>
        <td><a id='load' onclick="showLoadModal()" 
	   href="@ix.idg.controllers.routes.IDGApp.target(IDGApp.getId(t))">@t.name</a></td>

        <td><span class="label label-@t.idgTDL.label" data-toggle="tooltip" data-html="true" title="<p align='left'>@t.idgTDL.desc</p>">@t.idgTDL.name</span></td>
        <td>@t.idgFamily</td>
        <td>@IDGApp.format(t.novelty)</td>
        <td>@t.pubmedCount</td>
        <td>@t.grantCount</td>
        <td>@t.antibodyCount</td>
        <td>@t.patentCount <span class="inlinesparkline">@IDGApp.getPatentInfo(t)</span></td>
        @*<td><div style="display: inline;" id="radar-@IDGApp.getId(t)" class="radar-div"></div></td>*@
        <td><div id="radar-@IDGApp.getId(t)" class="radar-div"></div></td>
    </tr>
    @if(ctx != null) {
       @defining(IDGApp.getSeqAlignment(ctx, t)) { aln =>
         @if(aln != null) {
         <tr class="success">
	    <td colspan="10">
	      <pre>@{"identity = %.3f".format(aln.alignments(0).iden)}
@aln.alignments(0).alignment
</pre>
	    </td>
	 </tr>
	 }
       }
    }
}

@ix.ncats.views.html._content("Targets", "ix.idg.models.Target",
    ix.idg.controllers.routes.IDGApp.targets().url,
    current, rows, total, pages, facets) {
    @targetmenu(ctx)
} {
    <ol class="breadcrumb">
        <li><a href="@ix.idg.controllers.routes.IDGApp.index()"><span class="fa fa-home"></span> Home</a></li>
        @defining(request().queryString.get("facet")) { facets =>
            @if(facets != null) {
                <li><a href="@ix.idg.controllers.routes.IDGApp.targets()">Targets</a></li>
                @for(f <- facets) {
                    @if(f.startsWith(DTO_PROTEIN_CLASS)) {
                        @for(a <- IDGApp.getProteinAncestry(f)) {
                            <li><a href="@a.href">@a.term</a></li>
                        }
                        <li class="active">@f.substring(f.indexOf('/') + 1)</li>
		    }
		    @if(f.startsWith(PANTHER_PROTEIN_CLASS)) {
                        @for(a <- IDGApp.getAncestry(f, PANTHER_PROTEIN_ANCESTRY)) {
                            <li><a href="@a.href">@a.term</a></li>
                        }
                        <li class="active">@f.substring(f.indexOf('/') + 1)</li>
		    }
		    @if(f.startsWith(ChEMBL_PROTEIN_CLASS)) {
                        @for(a <- IDGApp.getAncestry(f, ChEMBL_PROTEIN_ANCESTRY)) {
                            <li><a href="@a.href">@a.term</a></li>
                        }
                        <li class="active">@f.substring(f.indexOf('/') + 1)</li>
		    }
                }
            } else {
                <li class="active">Targets</li>
            }
        }
    </ol>
} {

    <form>
    <table id="target-table" class="table table-striped">
        <tr>
          <th><button id="cb-addall" alt="Toggle check all"
	  	      style="padding: 3px"
	  	      class="btn btn-default" type="button">
	      <i class="fa fa-check fa-fw"></i></button></th>
            <th>Name</th>
            <th>Development Level</th>
            <th>Target Family</th>
	    @HtmlFormat.raw(IDGApp.getTargetTableHeader("Log Novelty", "novelty"))
	    @HtmlFormat.raw(IDGApp.getTargetTableHeader("PubMed Count", "pubmedCount"))
	    @HtmlFormat.raw(IDGApp.getTargetTableHeader("Grant Count", "grantCount"))
	    @HtmlFormat.raw(IDGApp.getTargetTableHeader("Antibody Count", "antibodyCount"))
	    @HtmlFormat.raw(IDGApp.getTargetTableHeader("Patent", "patentCount"))
	    @*HtmlFormat.raw(IDGApp.getTargetTableHeader("Monoclonal Antibody Count", "monoclonalCount"))*@
            <th>Data Types</th>
        </tr>
        @for(t <- targets) {
            @tabrow(t)
        }
    </table>
    </form>
} {  @* viz *@
    <div class="dropdown pull-right">
        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
            <i class="fa fa-shopping-cart"></i>&nbsp;<span id="sc-count"></span>
        </button>
            <ul class="dropdown-menu pull-left">
                <li><a href="#" id="sc-add-selected">Add Selected</a></li>
                <li><a href="#" id="sc-add-all">Add All</a></li>
                <li><a href="@ix.idg.controllers.routes.DossierApp.view(null)" id="sc-view">View Collections</a></li>
		<li><a href="#" id="sc-empty">Empty Collection</a></li>
            </ul>
    </div>
    <div class="dropdown pull-right">
      <button type="button" class="btn btn-default dropdown-toggle @if(request.getQueryString("q") == null && request.getQueryString("facet") == null) { disabled }" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
      style="margin-right: 5px">
        <i class="fa fa-eye"></i>
      </button>
      <ul class="dropdown-menu pull-left">
        <li><a  href="#hgramModal" data-toggle="modal" ><i class="fa fa-cubes"></i>&nbsp;Harmonogram</a></li>
        <li><a href="#" data-toggle="modal"><i class="fa fa-sitemap"></i>&nbsp;Kinase networks</a></li>
      </ul>
    </div>
} {
 @targetcarousel(ctx)
}

<div class="modal fade" tabindex="-1" role="dialog" id="loadmodal"
     aria-labelledby="mySmallModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <center><img src='@routes.Assets.at("ncats/images/spinners/294.GIF")'></center>
    </div>
  </div>
</div>

<div class="modal fade" id="modal-folder" tabindex="-1"
role="dialog" aria-labelledby="modalLabelFolder" aria-hidden="true">
    <div class="modal-dialog modal-lg" style="width: 40%; ">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close"
                data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="modalLabelFolder">Select a dossier</h4>
            </div>
            <div class="modal-body">
                @*<div class="row">*@
                    <div id="combo-container" >
                        <input id='folder-combobox' class="folder-typeahead" type="text">
                        <button type="button" id="button-select-folder" class="btn btn-primary">OK</button>
                    </div>
                @*</div>*@
            </div>
        </div>
    </div>
</div>

@modalradar(null)

<div class="modal fade" id="hgramModal" tabindex="-1"
     role="dialog" aria-labelledby="hgramModalLabel" aria-hidden="true" >
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close"
		data-dismiss="modal" aria-label="Close">
	  <span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="hgramModalLabel">Harmonogram</h4>
      </div>
      <div class="modal-body">
        <div class="embed-responsive embed-responsive-4by3">
            <div class="row">
                <div class="col-md-3" id='clust_instruct_container'>
                    <div id='viz_gmt_labels'></div>

                        <!-- toggle clustergram order -->
                    <div id='toggle_order' class="btn-group" data-toggle="buttons" >
                        <label class="btn btn-primary active order_name">
                            <input type="radio" name="options" id="clust_button" autocomplete="off" checked > Cluster
                        </label>
                        <label class="btn btn-primary order_name">
                            <input type="radio" name="options" id="rank_button" autocomplete="off" > Rank
                        </label>
                        @*<label class="btn btn-primary order_name">*@
                        @*<input type="radio" name="options" id="class_button" autocomplete="off" > Class*@
                        @*</label>*@
                    </div>

                        <!-- input box for gene search -->
                    <div class="form-group" id='gene_search_container'>
                        <label for="gene_search_box">Search for a Gene</label>
                        <input id='gene_search_box' type="text" class="form-control" placeholder="Input Gene" aria-describedby="sizing-addon2">
                        <button type="submit" id='submit_gene_button' class="btn btn-default">Search</button>
                    </div>
                    <p>Set column group size</p>
                    <div id="slider_col"></div>
                </div>
                <div class="col-md-9">
                    <div id='svg_div' class='svg_div' ></div>
                </div>
            </div>

        	</div>
      </div>
    </div>
  </div>
</div>

<head>
    <style type="text/css">
    .jqstooltip { box-sizing: content-box;}
    </style>
    <script type="text/javascript" src='@routes.Assets.at("javascripts/d3.js")'></script>
    <script type="text/javascript" src='@routes.Assets.at("javascripts/d3-tip.js")'></script>
    <script type="text/javascript" src='@routes.Assets.at("javascripts/underscore.js")'></script>
    <script type="text/javascript" src='@routes.Assets.at("javascripts/underscore.string.js")'></script>
    <script type="text/javascript" src='@routes.Assets.at("javascripts/d3_clustergram.js")'></script>
    <script type="text/javascript" src='@routes.Assets.at("javascripts/load_clustergram.js")'></script>
    <script type="text/javascript" src='@routes.Assets.at("javascripts/sunburst.js")'></script>
    <script type="text/javascript" src='@routes.Assets.at("javascripts/d3.layout.cloud.js")'></script>
    <script type="text/javascript" src='@routes.Assets.at("javascripts/kinome.js")'></script>
    <script type="text/javascript" src='@routes.Assets.at("javascripts/radar-chart.js")'></script>
    <script type="text/javascript" src='@routes.Assets.at("javascripts/cart.js")'></script>
    <script type="text/javascript" src='@routes.Assets.at("javascripts/jquery.sparkline.js")'></script>
    <script type="text/javascript" src='@routes.WebJarAssets.at(WebJarAssets.locate("raphael-min.js"))'></script>
    <script type="text/javascript" src='@routes.WebJarAssets.at(WebJarAssets.locate("morris.min.js"))'></script>
    <script type="text/javascript" src='@routes.WebJarAssets.at(WebJarAssets.locate("fabric.min.js"))'></script>
    <link type="text/css" rel="stylesheet" href='@routes.Assets.at("stylesheets/clustergram.css")' />
    <link type="text/css" rel="stylesheet" href='@routes.Assets.at("stylesheets/radar-chart.css")' />
    <link type="text/css" rel="stylesheet" href='@routes.WebJarAssets.at(WebJarAssets.locate("morris.css"))' />
</head>

<script>
$(function() {
   $('[data-toggle="popover"]').popover();
   $('[data-toggle="tooltip"]').tooltip ();
});

var _cart_selectType = "selected";

$(document).ready(function () {

   $('#loadmodal').on('shown.bs.modal', function (e) {
      console.log('loadmodal is shown...');
   });
   $('#hgramModal').on('shown.bs.modal', function (e) {
      console.log('hgram modal is shown...');
      load_clustergram ('@ix.idg.controllers.routes.HarmonogramApp.hgForTarget(null, ctx, null)');
   });
   $('#modal-radar').on('hidden.bs.modal', function (e) {
       d3.select("#modal-radardiv").select('svg').remove();
   });

    function selectEntities(sel) {
        return $(sel).map(function() {
            var id = $(this ).attr("id");
            if (id.indexOf("-") != -1) id = id.split("-")[1];
            return id;
        });
    }

    var folderNames = ['Default'];
    @for(f <- ix.idg.controllers.DossierApp.getFolderNames()) {
         @if( !f.equals("")) {
    folderNames.push('@f');
        }
    }

    $("#folder-combobox").typeahead(
        {hint:true,minLength:1,highlight:true },
        {source:substringMatcher(folderNames), name:'dossiers'}
    );
    $('#folder-combobox' ).typeahead('val', "Default");
    $('#folder-combobox').on("typeahead:selected", function (evt, val, d) {
        if (d == 'MeSH') {}
        else $('#folder-combobox').typeahead('val', +val.value);
    });

    $("#button-select-folder" ).on('click', function() {
        $('#modal-folder').modal('hide');
        var selectedFolderName = $("#folder-combobox" ).typeahead('val');
        var ents;
        if (_cart_selectType == 'selected')
            ents = selectEntities("#target-table  input:checked");
        else if (_cart_selectType == 'all')
            ents = selectEntities("#target-table  input");
        addEntitiesToShoppingCart(ents, 'ix.idg.models.Target', selectedFolderName, '@ix.idg.controllers.routes.DossierApp.addEntities()');
    });

    $.ajax({
        url:'@ix.idg.controllers.routes.DossierApp.count',
        dataType:'text',
        success:function(d) {
            $("#sc-count" ).html(d);
        }
    });
    // select all checkboxes in the table
    $("#cb-addall" ).click(function(e) {
        var cb = $("#cb-addall").find("i");
        var table = $("#target-table");
        if (cb.hasClass('fa-check')) {
            $ ( 'td input:checkbox',table ).prop ( 'checked', true ) ;
            $("#cb-addall" ).html('<i class="fa fa-remove fa-fw"></i>');
        } else {
            $ ( 'td input:checkbox',table ).prop ( 'checked', false ) ;
            $("#cb-addall" ).html('<i class="fa fa-check fa-fw"></i>');
        }
    });
    $("#sc-add-selected" ).click(function(e) {
        _cart_selectType = 'selected';
        $('#modal-folder').modal('show');
    });
    $("#sc-add-all" ).click(function(e) {
        _cart_selectType = 'all';
        $('#modal-folder').modal('show');
    });


    // iterate over all .radar-XXX elements and draw the radar chart
    // currently we pull chart data dynamically, but really should be
    // generated at compile time
    $("div[id^='radar-']" ).each(function() {
        var klass = $(this ).attr("id");
        var acc = klass.split("-")[1];
        $.ajax({
            url: '@ix.idg.controllers.routes.HarmonogramApp.hgForTarget(null,null,null,"radar-attr_type")'+'&q='+acc,
            dataType:"json",
            success:function(data) {
                var chart = RadarChart.chart();
                chart.config({
                    w:75, h:75,
                    axisText:false, levels:0, circles:false
                });
                var svg = d3.select("#"+klass).append('svg' )
                .attr("width", 75 )
                .attr("height", 75)
                .append('g').classed('focus', 1).datum(data).call(chart);
            }
        });
    });

    $("#target-table" ).on("click", ".radar-div", function() {
        var target = $(this ).attr("id" ).split("-")[1];
        $.ajax({
            url: '@ix.idg.controllers.routes.HarmonogramApp.hgForTarget(null,null,null,"radar-attr_type")'+'&q='+target,
            dataType:"json",
            success:function(data) {
                var chartConfig = getModalChartConfig('@ix.idg.controllers.routes.HarmonogramApp.dataSources(null,null)'+'?field=radar-attr_type');
                $("#modal-radardiv" ).attr("target", target);
                $("#modalLabelRadar" ).text("Data type summary for "+target);
                renderChart(data, chartConfig);
            }
        });
    });

    $("#select-agg" ).on('change', function() {
        var aggType = $(this ).val();
        var target = $("#modal-radardiv" ).attr("target");
        var overlay = $("#select-overlay" ).val();
        var chartConfig = getModalChartConfig('@ix.idg.controllers.routes.HarmonogramApp.dataSources(null,null)' + '?field=' + aggType);
        var ptd = $.get('@ix.idg.controllers.routes.HarmonogramApp.hgForTarget(null,null,null,null)'+'?q='+target+'&type='+aggType);
        var pud;
        if (overlay == 'none')
            pud = $.Deferred().resolve().promise();
        else
            pud = $.get('@ix.idg.controllers.routes.HarmonogramApp.hgForTarget(null,null,null,null)'+'?q='+overlay+'&type='+aggType);
        $.when(ptd, pud).then(function(atd, aud) {
            var chartData = atd[0];
            if (overlay != 'none')
                chartData.push(aud[0][0]);
            $("#modalLabelRadar" ).text("Data type summary for "+target);
            renderChart(chartData, chartConfig);
        });
    });
    $("#select-overlay" ).on('change', function() {
        var aggType = $("#select-agg"   ).val();
        var target = $("#modal-radardiv" ).attr("target");
        var chartConfig = getModalChartConfig('@ix.idg.controllers.routes.HarmonogramApp.dataSources(null,null)' + '?field=' + aggType);
        var overlay = $(this).val();
        var ptd = $.get('@ix.idg.controllers.routes.HarmonogramApp.hgForTarget(null,null,null,null)'+'?q='+target+'&type='+aggType);
        var pud;
        if (overlay == 'none')
            pud = $.Deferred().resolve().promise();
        else
            pud = $.get('@ix.idg.controllers.routes.HarmonogramApp.hgForTarget(null,null,null,null)'+'?q='+overlay+'&type='+aggType);
        $.when(ptd, pud).then(function(atd, aud) {
            var chartData = atd[0];
            if (overlay != 'none')
                chartData.push(aud[0][0]);
            $("#modalLabelRadar" ).text("Data type summary for "+target);
            renderChart(chartData, chartConfig);
        });
    });

    $("#sc-empty").click(function (e) {
        $.get('@ix.idg.controllers.routes.DossierApp.emptyCart', function (d) {
    	    console.log(d);
    	    $("#sc-count" ).html('');
    	});
    });

     $('.inlinesparkline').sparkline('html', {width:'50px'});
});

function showLoadModal () {
  console.log('showing modal...');
  $('#loadmodal').modal({
      keyboard: false,
      show: true,
      backdrop: 'static'
    });
}

$(window).unload(function () {
    $('#loadmodal').modal('hide');
    $('#hgramModal').modal('hide');
    $('#modal-folder').modal('hide');
});
</script>
